steps:
  - name: Checkout repository
    uses: actions/checkout@v4

  - name: Prepare directories
    run: |
      mkdir thirdparty\SDL2\include
      mkdir thirdparty\SDL2\lib\x64
      mkdir thirdparty\oidn\include
      mkdir thirdparty\oidn\lib
    shell: cmd

  - name: Download SDL2 (dev package) and extract
    shell: pwsh
    run: |
      $sdlUrl = 'https://www.libsdl.org/release/SDL2-devel-2.0.26-VC.zip'
      Invoke-WebRequest -Uri $sdlUrl -OutFile sdl.zip
      Expand-Archive sdl.zip -DestinationPath sdl_tmp -Force

      # Copy headers
      Get-ChildItem -Path sdl_tmp -Filter '*.h' -Recurse | ForEach-Object {
        Copy-Item $_.FullName -Destination thirdparty\SDL2\include -Force
      }

      # Copy .lib and SDL2.dll (x64) into thirdparty/SDL2/lib/x64
      Get-ChildItem -Path sdl_tmp -Filter '*.lib' -Recurse | ForEach-Object {
        Copy-Item $_.FullName -Destination thirdparty\SDL2\lib\x64 -Force
      }
      Get-ChildItem -Path sdl_tmp -Filter 'SDL2.dll' -Recurse | ForEach-Object {
        Copy-Item $_.FullName -Destination thirdparty\SDL2\lib\x64 -Force
      }

  - name: Download OpenImageDenoise (OIDN) and extract
    shell: pwsh
    run: |
      # Adjust version if you prefer a newer oidn release
      $oidnUrl = 'https://github.com/OpenImageDenoise/oidn/releases/download/v1.2.4/oidn-1.2.4-windows.zip'
      Invoke-WebRequest -Uri $oidnUrl -OutFile oidn.zip
      Expand-Archive oidn.zip -DestinationPath oidn_tmp -Force

      # Copy headers
      Get-ChildItem -Path oidn_tmp -Filter '*.h' -Recurse | ForEach-Object {
        Copy-Item $_.FullName -Destination thirdparty\oidn\include -Force
      }

      # Copy .lib and .dll files to thirdparty/oidn/lib
      Get-ChildItem -Path oidn_tmp -Include '*.lib','*.dll' -Recurse | ForEach-Object {
        Copy-Item $_.FullName -Destination thirdparty\oidn\lib -Force
      }

  - name: Show thirdparty layout (debug)
    run: |
      dir thirdparty /s
    shell: cmd

  - name: Configure with CMake (Visual Studio generator)
    run: |
      cmake -S . -B build -G "Visual Studio 17 2022" -A x64
    shell: bash

  - name: Build (Release)
    run: |
      cmake --build build --config Release -- /m
    shell: bash

  - name: Locate build outputs
    shell: pwsh
    run: |
      Write-Host "Searching for PathTracer exe and DLLs..."
      $exe = Get-ChildItem -Path build -Filter "PathTracer*.exe" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
      if (-not $exe) {
        Write-Error "PathTracer executable not found in build/ - check build logs."
        exit 1
      }
      Write-Host "Found exe: $($exe.FullName)"
      Get-ChildItem -Path build -Include '*.dll' -Recurse | ForEach-Object { Write-Host "DLL: $($_.FullName)" }

      # Prepare packaging dir
      Remove-Item -Recurse -Force out 2>$null || $null
      New-Item -ItemType Directory -Path out

      Copy-Item $exe.FullName -Destination out -Force
      Get-ChildItem -Path build -Include '*.dll' -Recurse | ForEach-Object {
        Copy-Item $_.FullName -Destination out -Force
      }

      # copy shaders and assets if present
      if (Test-Path src\shaders) { Copy-Item src\shaders -Destination out\shaders -Recurse -Force }
      if (Test-Path assets) { Copy-Item assets -Destination out\assets -Recurse -Force }

  - name: Create zip artifact
    shell: pwsh
    run: |
      $zip = "PathTracer-win.zip"
      if (Test-Path $zip) { Remove-Item $zip -Force }
      Add-Type -AssemblyName System.IO.Compression.FileSystem
      [IO.Compression.ZipFile]::CreateFromDirectory("out", $zip)
      Write-Host "Created $zip with:"
      Get-ChildItem -Path out -Recurse

  - name: Upload build artifact
    uses: actions/upload-artifact@v4
    with:
      name: PathTracer-windows
      path: PathTracer-win.zip
